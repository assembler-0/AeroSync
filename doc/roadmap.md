# [AeroSync](https://github.com/assembler-0/AeroSync)

> This is the AeroSync kernel development checklist for release 9 (9–12 years, r0c1-2.2.3 → r9c0-xx.x.x)

### core
- memory management (mm)
	- [x] **Phase 0: The "Aero-Fast" Foundation (Maple & SPF)**
		- [x] **Maple Tree Integration**: Full migration from RB-tree/Linked-list to **True Maple Tree** MAS API.
		- [x] **Performance Optimization**: O(1) sequential allocation hinting, range-optimized iteration (O(affected VMAs)), and O(N) bulk destruction.
		- [x] **Full Speculative Page Faults (SPF)**: Lockless fault handling via RCU and VMA sequence counters.
		- [x] **Shadow Object Optimization**: Efficient XArray-based COW chain collapsing.
	- [x] **Phase 1: The "Magnum" Page Allocator (Performance & Scalability)**
		- [x] **Zonelists**: Implement pre-calculated fallback lists (Local -> Remote Sorted by Distance) to replace O(N) search in `alloc_pages`.
		- [x] **Batched PCP Draining**: Optimize `free_pcp_pages` to bulk-return pages to the buddy system, amortizing lock contention.
		- [x] **Node-Local Allocation**: Enforce strict node locality policies by default, falling back only when necessary.
		- [x] **Lockless Fastpaths**: Verify and harden `cmpxchg` usage in PCP and SLUB hotpaths.
	- [x] **Phase 1.5: Workingset + Shadow Chain Hardening**
		- [x] **Workingset Refault Detection**: Shadow entry encoding in XArray for detecting thrashing
		- [x] **Shadow Chain Depth Tracking**: `shadow_depth`, `collapse_threshold`, `shadow_children` in vm_object
		- [x] **Async Shadow Collapse**: Background collapse via `vm_object_try_collapse_async()`
		- [x] **XArray Entry Type Encoding**: Unified encoding for folio/ZMM/swap/shadow entries (bits [1:0])
	- [x] **Phase 1.6: Swap Subsystem**
		- [x] **swp_entry_t Encoding**: Type (bits 63-58) + offset for swap slot identification
		- [x] **Swap Slot Allocation**: Cluster-based allocation with `swap_info_struct`
		- [x] **Swap Cache**: XArray-based cache for in-flight swap pages
		- [x] **Swap Readahead**: Configurable cluster readahead (MM_SWAP_READAHEAD)
	- [x] **Phase 1.7: Enhanced MGLRU**
		- [x] **Bloom Filters**: Per-generation bloom filters for efficient page table scanning
		- [x] **Per-Gen Statistics**: `lru_gen_stats` with refaults/scanned/reclaimed/promoted counters
		- [x] **Tiered Reclaim**: Enhanced `scan_control` with may_writepage/may_unmap/may_swap flags
		- [x] **ZMM-first Reclaim**: Try compression before swap in `folio_reclaim()`
	- [x] **Phase 1.8: VM Performance Hardening (Microsecond-Class)**
		- [x] **Lockless A/D Bit Reading**: `vmm_is_accessed()`/`vmm_is_dirty()` use atomic loads, no PTL
		- [x] **Batched TLB Shootdowns**: `vmm_clear_accessed_no_flush()` + single flush in `folio_referenced()`
		- [x] **Per-CPU LRU Batching**: `lru_batch` (15 folios) reduces `pgdat->lru_lock` contention ~15x
		- [x] **Pre-Zeroed Page Table Cache**: Per-CPU `pgt_cache` (4 pages) eliminates memset from hot path
		- [x] **Optimized VMA Verification**: Branch-prediction-friendly `vma_verify()` with `unlikely()` hints
		- [x] **Streamlined Fault Path**: Removed redundant VMA magic checks (already done in `vma_find()`)
	- [x] **Phase 2: Cache-Efficient Structures (Maple Tree & XArray)**
		- [x] **Maple Tree**: Replace VMA RB-tree with Maple Tree (Linux-style) for cache-aligned, multi-element nodes and O(1) interval lookups.
		- [x] **XArray (Radix Tree 2.0)**: Replace `vm_object` page RB-trees with XArray for better cache locality and faster large-file/SHM mapping.
		- [x] **Aggressive Fault-Around**: Expand fault-around window (currently +/- 1 page) to dynamic windows (16-64KB) for better spatial locality.
	- [x] **Phase 2.5: Deep Shadow Compaction & UBC Hardening**
		- [x] **Aggressive Shadow Collapsing**: Flatten deep COW chains during faults to maintain O(1) lookup.
		- [x] **Iterative Shadow Lookup**: Replaced recursive faulting with safe iterative chain walking to prevent kernel stack overflow.
		- [x] **Clustered Writeback**: Group contiguous dirty pages in UBC for high-throughput disk I/O.
		- [x] **Thrash-Aware Readahead**: Adaptive readahead window that shrinks under memory pressure and detects thrashing.
	- [x] **Phase 2.6: Production-Grade Fault Scaling**
		- [x] **Per-VMA Locking**: Fine-grained fault serialization using `vma_lock` to eliminate `mmap_lock` contention.
		- [x] **Direct Reclaim Integration**: Enforce hard memory limits in ResDomain by triggering synchronous reclaim on charge failure.
		- [x] **Proportional Writeback Throttling**: Throttled dirty page creation based on system-wide writeback speed.
	- [ ] **Phase 4: Userspace & Device Infrastructure (Production Grade)**
		- [x] **Recursive Path Lookup**: Implement robust `vfs_path_lookup` in `namei.c` with support for `..`, `.`, symlinks, and mount point crossing.
		- [ ] **Unified Device Model (UDM) Integration**: 
			- [x] **Char Device Layer**: `register_chrdev` API with major/minor number management.
			- [x] **Block Device Layer**: Refine block I/O request queues and bio-like structures.
			- [x] **DevFS**: Pseudo-filesystem for automatic device node exposure in `/dev`.
		- [x] **Advanced VFS Integration**:
			- [x] **fs_struct**: Implement per-process root and working directory.
			- [x] **Mount Management**: Implement a global mount tree and `sys_mount`/`sys_umount`.
			- [x] **File-backed mmap**: Complete the link between `inode->i_ubc` and `vm_area_struct`.
			- [x] **Everything-is-a-file**: Unified `devfs` linkage where UDM `struct device` automatically appears in `/dev`.
		- [x] **Terminal & TTY Subsystem**:
			- [x] **TTY Core**: Generic TTY driver with line discipline support (N_TTY).
			- [ ] **Virtual Consoles**: Support for multiple TTYs on the same display/serial.
			- [ ] **PTY (Pseudo-Terminals)**: Support for terminal emulators and SSH.
		- [ ] **Initial RAM Disk (Initrd)**:
			- [ x **USTAR/CPIO Parser**: Support for loading early userspace from bootloader-provided modules.
			- [ ] **Rootfs Pivot**: Mechanism to switch from initrd to a persistent root filesystem.
		- [ ] **POSIX System Call Bridge**:
			- [x] Complete `open`, `close`, `read`, `write`, `ioctl`, `lseek`, `fstat`, `poll`, `select`.
			- [x] **VFS Event System**: Robust bitmask-based notification system with per-dentry subscriber lists.
			- [ ] Implement `pipe()` and `dup2()` for shell support.
	- [ ] **Phase 5: Advanced FS & Performance**
		- [x] **Unified Buffer Cache (UBC)**: Integrate page cache with block layer for zero-copy file I/O.
		- [x] **Kernel UBC API**: Implemented `ubc_map_page` and `ubc_unmap_page` for safe kernel-side buffer access.
		- [x] **Writeback Engine**: Dedicated threads for flushing dirty pages to disk.
	- [x] **Phase 6: Advanced Loader Overhaul (Production Grade)**
		- [x] **Userspace ELF Overhaul**:
			- [x] **PIE Support**: Full support for Position Independent Executables with dynamic load bias.
			- [x] **PT_INTERP Support**: Robust loading and linking of dynamic interpreters (e.g., ld-linux.so).
			- [x] **Full System V ABI Stack**: Compliant stack frame setup with argc, argv, envp, and Auxiliary Vector (AuxV).
			- [x] **Integrated RNG**: Use kernel unified crypto stack (sw_rng) for `AT_RANDOM` vector initialization.
		- [x] **FKX Module Loader Hardening**:
			- [x] **Strict Segment Permissions**: Per-segment protection (RX for code, RW for data, RO for constants) using `vmm_set_flags`.
			- [x] **Expanded Relocations**: Support for GCC/LLVM complex relocations (`R_X86_64_GOTPCREL`, `R_X86_64_32S`, etc.).
			- [x] **Multi-Compiler Compatibility**: Relaxed ELF type checks to support both `ET_DYN` and `ET_REL` modules from varied toolchains.
			- [x] **Weak Symbol Resolution**: Proper handling of `STB_WEAK` bindings and undefined symbols.
	- [x] **vmalloc**: use maple tree for vmalloc
	- [x] **Phase 3: Robustness & Advanced Features**
		- [x] **OOM Killer 2.0**: Implement a "Reaper" thread to asynchronously reclaim memory from killed tasks, preventing deadlocks.
		- [x] **Hardened Usercopy**: Rigorous bounds checking for `copy_from_user`/`copy_to_user` based on VMA limits.
		- [x] **Kernel Guard Pages**: Unmapped guard pages between vmalloc stacks.
		- [x] **Transparent Huge Pages (THP)**: Background promotion of contiguous 4KB pages to 2MB pages using a dedicated `khugepaged` daemon.
	- [x] proper COW (Copy-On-Write) using XNU-inspired Shadow Object chains
	- [x] Finish RMAP for all subsystems
	- [x] Advance ANON object fault
	- [ ] SHM (SHared Memory) management +IPC)
	- [x] Use XArray/Radix tree for `vm_object` (with entry type encoding)
	- [x] Selective lazy allocation/free for kernel `vmalloc()
	- [ ] Fix subtle, logic bugs
	- [x] True memory reclamation
	- [x] Integrate with VFS
	- [x] working `mmap`/`munmap`/`mprotect`/`mremap`
	- [ ] add `brk` and `sbrk` for compatibility
	- [x] Cache *everywhere*, (UBC - Unified Buffer Cache)
	- [x] Magazines integration for SLUB
	- [x] Faster SLUB
	- [x] More sophisticated PMM system (buddy `page_alloc`)
	- [x] Streamline the use of `struct folio` rather than `struct page` for high-level mm
	- [x] KASLR (PIC/PIE)
	- [x] ASLR
	- [x] Guard pages where possible
	- [x] Proper DMA support for legacy devices
	- [x] IOMMU
	- [x] more rigid MMIO
	- [x] Stack management
	- [x] handle user MM faults gracully
- scheduling
	- [x] PI (Priority Inheritance)
	- [x] Per-Entity Load Tracking (PELT) - 32ms half-life decaying averages
	- [x] Newly Idle Balancing - Pull tasks from busy CPUs when entering idle
	- [x] Proper scheduling classes and domains hierarchy
	- [x] Basic SMT/MC topology support for load balancing
	- [x] Fixed wait queue locking and safety
	- [x] ACPI SRAT parsing for NUMA topology (SMT -> MC -> NUMA)
	- [x] LLC-aware wake-up balancing (select_idle_sibling)
	- [x] vruntime normalization/denormalization on migration
	- [x] Aggressive multi-task load balancing (move load, not just tasks)
	- [x] Cross-CPU wake-up preemption (IPI)
	- [x] XNU-style synchronous priority handoff
	- [x] CFS Bandwidth Control (CPU Quotas)
	- [x] Hybrid (E/P Core) Awareness
	- [x] RCU-protected Task List
- VFS
	- [x] FD allocation
	- [ ] proper FD table
	- [ ] FD management
	- [ ] register/unregister FSes
	- [ ] raw FS stack
	- [ ] *everything-is-a-file*
	- [ ] permission (Unix or ACL?)
	- [ ] Linux-like
	- [x] **Block Device Abstraction**
		- [x] Standardized naming (`hd a-z`, `sd a-z`)
		- [x] MBR Partition Scanning & Support
		- [x] Transparent Partition I/O redirection
	- [ ] FAT32
	- [ ] EXT4 (RO)
	- [ ] XFS (RO)
	- [ ] EROFS (`/system`)
	- [ ] ASFS (AeroSyncFileSystem?) 
	- [ ] devfs/procfs/tmpfs
	- [ ] overlayfs
	- [ ] USTAR
	- [ ] ISOFS (ISO9660 + RockRidge extension)
	- [x] NEWC CPIO
	- [ ] File systems as a module
- POSIX-compliant
	- [x] `open()`/`close()`
	- [x] pipes
	- [ ] sockets
	- [ ] mman
	- [x] System V ABI (implicit!!)
	- [ ] Binary compatibility with Linux
	- [x] Linux syscall table
- modularity
	- [x] FKX (Fused Kernel eXtension)
	- [x] **ASRX (AeroSync Runtime eXtension)**: Full support for loadable kernel extensions with System V ABI relocations, license enforcement, and safe unloading support.
	- [ ] rFKX (runtime Fused Kernel eXtension) (FKX modules that can be loaded at any time, not early boot)
	- [ ] ASRX (AeroSync Runtime eXtension) - DUPLICATE REMOVED
	- [ ] generic interface for *everything* (Linux-inspired)
	- [x] **Full Unified Driver Model (UDM)**
		- [x] `struct device` with `kref` reference counting
		- [x] Generic Attribute System (`struct attribute`, `sysfs` foundation)
		- [x] Platform Bus for non-discoverable devices
		- [x] Topology hardening (Attribute groups, race-free creation)
	- [ ] **UDM Hardening & Driver Unification (Production Grade)**
		- [x] **Managed Resources (devres)**: Implement base `devres` API and `devm_kzalloc`.
		- [ ] **Unified Resource Management**: Implement `devm_ioremap` and `devm_request_irq` for automatic cleanup.
		- [ ] **Global Resource Tree**: Standardize `struct resource` and implement a global tree for I/O and Memory tracking.
		- [x] **Standardized Driver Lifecycle**: Enforce `probe`/`remove`/`shutdown`/`suspend`/`resume` symmetry across all subsystems.
		- [x] **Hierarchical Device Tree**: Ensure proper parent-child relationships (e.g., PCI -> AHCI -> SATA).
		- [ ] **Generic IRQ Mapping**: Abstract IRQ allocation and routing behind UDM to support MSI/MSI-X transparently.
		- [x] **SysFS-like Attributes**: Expand `struct attribute` for runtime device introspection.
	- [x] **Enhanced SYSINTF**
		- [x] Configurable via Kconfig
	- [ ] skeleton kernel
	- [ ] don't be like XNU
- features (quality of life)
	- [x] backtrace (builtin)
	- [x] stack trace (builtin)
	- [x] linux-compatible spinlock 
	- [ ] kbdg embeded
	- [ ] automatic rollback
	- [ ] should not panic
	- [ ] true asynchronous printk (that doesnt blow up)
	- [ ] log level filtering
	- [x] component based logs
	- [ ] component based log parsing (and filtering)
	- [ ] ksym should be somewhere else not FKX
	- [ ] configurability (CMake or kconfiglib)
	- [ ] configurable run targets with CMake caches
	- [x] Capability based kernel
	- [ ] runs on cursed PCs
	- [ ] support S1-5 states?
- drivers
	- [ ] NVMe driver (for my pc)
	- [ ] AHCI driver
	- [x] PIO/DMA IDE (ATA) driver (Basic read/write + identification)
	- [ ] ATAPI driver
	- [ ] virtio-block driver
	- [ ] USB mass storage device
	- [ ] xHCI controller stack (usable for OHCI & EHCI)
	- [ ] PCIe with MSI and MSI-X
	- [ ] ACPICA
	- [x] SMBIOS
	- [ ] True time counting
	- [x] Software timer
	- [ ] Unified input stack
	- [ ] PS2 keyboard and mouse
	- [ ] USB keyboard and mouse
	- [x] proper APIC stack (enhance for more features)
	- [x] Oneshot mode support
	- [x] EFI RT table support
	- [ ] ARP/ICMP Stack
	- [ ] UDP stack
	- [ ] TCP/IP (v4 and v6) support
	- [ ] port intel iwlwifi driver or write my own for the AC9560
	- [ ] E1000
	- [ ] NE2000
	- [ ] RTL8139
	- [x] PCI bus enumeration using ECAM
	- [ ] VMware SVGA II driver
	- [ ] virtio-pci-gpu driver
	- [ ] a fraction of AMDGPU driver
	- [ ] AGP & ISA bus cuz why not? though pretty much a waste of time
	- [ ] Advances serial driver (just handle edge cases really)
	- [ ] Some generic sound
	- [ ] ALC897 driver
	- [ ] SIO (Super IO chip) driver
	- [ ] intel & amd PCH driver
	- [ ] EC integration with ACPI
	- [ ] C-states support
	- [x] Hybrid architecture handling
	- [ ] CPU microcode loading
	- [x] PTY & TTY drivers
	- [x] CSPRNG using a TRNG (kind of)
