# SPDX-License-Identifier: GPL-2.0-only

menu "system"

config ASYNC_PRINTK
    bool "Enable asynchronous printk"
    default y
    help
      Enables high-performance asynchronous logging
      framework for printk

config MAX_CPUS
    int "Maximum # supported of logical processor(s)"
    default 512

menu "CPU topology"

config RDPID_SUPPORT
    bool "Support RDPID instruction"
    default y
    help
      Enables detection and support for the RDPID instruction, which
      allows fast retrieval of the logical CPU ID.

config RDPID_CPU_ID
    bool "Use RDPID for logical CPU ID"
    depends on RDPID_SUPPORT
    default n
    help
      Use the RDPID instruction to retrieve the logical CPU ID.
      This is faster than reading from the per-CPU area via GS.
      Requires RDPID_SUPPORT and hardware support.

endmenu

menu "Synchronization Primitives"

config TICKET_SPINLOCKS
    bool "Ticket Spinlocks"
    default y
    help
      Use fair ticket-based spinlocks instead of simple test-and-set locks.
      This ensures FIFO order and prevents CPU starvation under contention.

config MCS_SPINLOCKS
    bool "MCS Spinlocks"
    default y
    help
      Enable support for MCS (Mellor-Crummey and Scott) locks.
      MCS locks are highly scalable and perform well under high contention
      by having each CPU spin on its own local variable.

config DEBUG_SPINLOCK
    bool "Spinlock debugging"
    default n
    help
      Enable extra checks and debugging information for spinlocks,
      including owner tracking and deadlock detection.

endmenu

menu "RCU Subsystem"

config TREE_RCU
    bool "Tree-based RCU (Scalable SMP RCU)"
    default y if MAX_CPUS > 1
    help
      This option selects a hierarchical RCU implementation that is
      scalable for systems with many CPUs.

config TINY_RCU
    bool "Tiny RCU (Non-preemptible single-CPU RCU)"
    default n
    depends on MAX_CPUS = 1
    help
      This option selects a very small RCU implementation for
      single-CPU systems.

config RCU_FANOUT
    int "Tree-based RCU leaf-level fanout"
    depends on TREE_RCU
    default 16
    help
      This option controls the number of CPUs per leaf rcu_node.
      Smaller values increase tree depth and lock contention for
      reporting quiescent states, while larger values increase
      lock contention on the leaf nodes themselves.

config RCU_BOOST
    bool "Enable RCU priority boosting"
    depends on TREE_RCU
    default y
    help
      This option enables RCU priority boosting, which allows
      low-priority RCU read-side critical sections to be
      preempted and then boosted to a higher priority to avoid
      holding up grace periods.

config RCU_KTHREAD_PRIO
    int "RCU kthread priority"
    depends on TREE_RCU
    default 1
    help
      Set the priority of the RCU kthreads.

config SRCU
    bool "Sleepable Read-Copy-Update (SRCU)"
    default y
    help
      This option enables Sleepable RCU, which allows readers to sleep
      within their read-side critical sections.

config RCU_PERCPU_TEST
    bool "Enable RCU and Per-CPU dynamic allocation tests"
    default n
    help
      Enables RCU and Per-CPU dynamic allocation smoke tests during boot.

endmenu

menu "Per-CPU Subsystem"

config DYNAMIC_PER_CPU
    bool "Support for dynamic per-CPU allocation"
    default y
    help
      Enables alloc_percpu() and free_percpu() APIs for allocating
      per-CPU variables at runtime.

config PER_CPU_CHUNK_SIZE
    int "Size of each dynamic per-CPU chunk (KB)"
    depends on DYNAMIC_PER_CPU
    default 64
    help
      Determines the size of each chunk used for dynamic per-CPU
      allocations. Each CPU will have this much space reserved.

endmenu

menu "Panic Configuration"

config PANIC_STACKTRACE
    bool "Enable stacktrace on panic"
    default y
    help
      Enables kernel stack unwinding and symbol resolution when a
      kernel panic occurs.


config PANIC_DUMP_REGISTERS
    bool "Always dump registers on panic"
    default y
    help
      Dump CPU general purpose and control registers on all panics,
      not just exceptions.

config PANIC_TIMEOUT
    int "Panic timeout (seconds)"
    default -1
    help
      Number of seconds to wait before rebooting after a panic.
      Set to -1 to wait indefinitely, or 0 to reboot immediately.

config PANIC_VERBOSE
    bool "Verbose panic messages"
    default y
    help
      Display extra information like CPU ID, current task name,
      and kernel version on panic.

endmenu

menu "Command Line"

config CMDLINE_BUF_SIZE
    int "Command line buffer size"
    default 4096
    help
      Maximum size of the command line string that can be parsed.

config CMDLINE_MAX_OPTS
    int "Maximum number of command line options"
    default 128
    help
      Maximum number of distinct key=value or flag options that can be stored.

config CMDLINE_MAX_KEY
    int "Maximum length of a command line key"
    default 64

config CMDLINE_MAX_VAL
    int "Maximum length of a command line value"
    default 256

config CMDLINE_OVERRIDE
    string "Built-in command line override"
    default ""
    help
      If non-empty, this command line will be used instead of the one
      provided by the bootloader.

config CMDLINE_APPEND
    string "Built-in command line append"
    default ""
    help
      If non-empty, this string will be appended to the command line
      provided by the bootloader.

endmenu

source "aerosync/sysintf/Kconfig"

menu "Module Management"

config LIMINE_MODULE_MANAGER
    bool "Enable Limine Module Manager (LMM)"
    default y
    help
      Enable the centralized Limine Module Manager to manage and probe
      bootloader-provided modules.

config LMM_PROBE_EXTENSION_FIRST
    bool "Biased probing: check file extensions first"
    depends on LIMINE_MODULE_MANAGER
    default y
    help
      If enabled, the LMM will check file extensions before running
      registered probers. This can speed up boot if many modules are present.

config LMM_SORT_BY_PRIORITY
    bool "Enable priority-based module sorting"
    depends on LIMINE_MODULE_MANAGER
    default n
    help
      Enable sorting modules by priority before processing.

endmenu

endmenu
